# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении:

Товар

```
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null; 
}
```
Интерфейс, описывающий структуру данных заказа
```
export interface IOrderData {
	payment: TPayment | string;
	email: string;
	phone: string;
	address: string;
	total: number | null;
	items: string[];
}
```

Интерфейс для модели данных товаров

```
export interface IProductsData {
	products: IProduct[];
	preview: IProduct;
	total: number;
	setProducts(products: IProduct[]): void;
	selectProduct(item: IProduct): void;
}
```
Интерфейс для модели данных корзины
```
export interface IBasket {
	items: IProduct[];
	totalAmount: number | null;
	addItem(product: IProduct): void;
	removeItem(product: IProduct): void;
	getItemCount(): number;
	updateTotalAmount(): void;
	clearBasket(): void;
}
```
Интерфейс для модели данных формы
```
export interface ICheckoutForm {
	payment: TPayment;
	email: string;
	phone: string;
	address: string;
	total: number | null;
	items: string[];
	updatePaymentAndAddressInfo(
		field: keyof TPaymentFormInfo,
		value: string | TPayment
	): void;
	updateContactInfo(field: keyof TContactFormInfo, value: string): void;
	createOrderData(): object;
	clearForm(): void;
}
```

Данные способа оплаты

```
export type TPayment = 'cash' | 'card';
```
Данные карточки на главной странице

```
type TMainProductCardInfo = Pick<IProduct, 'id' | 'image' | 'title' | 'category' | 'price'>;
```
Данные карточки в корзине

```
type TBasketInfo = Pick<IProduct, 'title' | 'price'>;
```
Данные модального окно формы оплаты

```
type TPaymentFormInfo = Pick<IOrderData, 'paymentMethod' | 'deliveryAddress'>;
```
Данные модального окна формы контактов

```
type TContactFormInfo = Pick<IOrderData, 'email' | 'phone'>;
```

Допустимые HTTP-методы для отправки данных: POST, PUT или DELETE
```
type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

IApi — интерфейс, описывающий базовую структуру API клиента для взаимодействия с сервером.
```
export interface IApi {
	baseUrl: string;
	get<T>(uri: string): Promise<T>;
	post<T>(uri: string, data: object, method?: ApiPostMethods): Promise<T>;
}
```

## Архитектура приложения:

Код приложения разделен на слои согласно парадигме MVP:
- Слой представления, отвечает за отображение данных на странице
- Слой данных, отвечает за хранение и изменение данных
- Презентер, отвечает за связь представления и данных

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

Методы:
- `get` - выполняет `GET` запрос на переданный в параметрах эндпоинт и возвращает промис с объектом, которым ответил сервер.
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на эндпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие.
- `emit` - инициализация события.
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие.

### Слой данных

#### Класс ProductCardsData

Класс отвечает за хранение и логику работы с данными карточек товаров.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `_products: IProduct[]` - массив объектов карточек;
- `_preview: IProduct | null` - объект, представляющий выбранный товар;
- `_total: number` — общее количество товаров в массиве;
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `selectProduct(item: IProduct): void` - выбирает карточку;
- `setProducts(products: IProduct[]): void` — метод для установки массива товаров. Обновляет количество товаров и эмитирует событие products:updated;
- `getProduct(cardId: string): IProduct | undefined` — метод для получения товара по его идентификатору;
- `сеттеры` и `геттеры` для сохранения и получения данных из полей класса;

#### Класс BasketData

Класс отвечает за работу с данными в корзине.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `items: IProduct[]` - массив объектов типа TBasketInfo, содержащий информацию о товарах в корзине. Каждый объект включает название товара и его цену; 
- `totalAmount: number | null` - хранит общую сумму всех товаров в корзине. Изначально может быть null, если корзина пуста; 
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `addItem(product: IProduct): void` - добавляет товар в корзину и добавляет его в массив `items`; 
- `removeItem(product: IProduct): void` - удаляет товар из корзины. Ищет и удаляет элемент в массиве `items`, соответствующий переданному товару.; 
- `getItemCount(): number` - возвращает количество товаров в корзине, равное длине массива items; 
- `updateTotalAmount(): void` - вычисляет общую стоимость товаров в корзине, суммируя цены всех элементов в массиве `items`; 
- `clearBasket(): void` - полностью очищает корзину, обнуляя массив `items` и сбрасывая totalAmount в null; 

#### Класс FormData

Класс отвечает за работу с данными в форме.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `payment: TPayment | null` — способ оплаты (наличные или карта), изначально null;
- `email: string` — электронная почта пользователя;
- `phone: string` — номер телефона пользователя;
- `address: string` — адрес доставки;
- `total: number | null` — общая сумма заказа, изначально может быть null;
- `items: string[]` — массив товаров, которые входят в заказ (идентификаторы товаров);
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `updateTotalAndItems(totalAmount: number | null, items: string[]): void` — обновляет общую сумму и список товаров в заказе. Эмитирует событие - form:totalAndItemsUpdated.\
- `updatePaymentAndAddressInfo(field: keyof TPaymentFormInfo, value: string | TPayment): void` — обновляет информацию о способе оплаты или адресе доставки в зависимости от переданного поля. Эмитирует событие form:paymentAddressUpdated.\
- `updateContactInfo(field: keyof TContactFormInfo, value: string): void` — обновляет контактные данные (email или телефон). Эмитирует событие form:contactUpdated.\
- `createOrderData(): IOrderData` — формирует объект данных заказа, включая товары, итоговую сумму, контактные данные, способ оплаты и адрес доставки. Если общая сумма равна нулю или null, выбрасывает ошибку.\
- `clearForm(): void` — очищает все данные формы (способ оплаты, адрес, контактные данные, товары и сумма) и эмитирует событие form:cleared.

### Слой представления

Все классы представления отвечают за отображение внутри контейнера (DOM - элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем для некоторых компонентов слоя представления. В дженерик передается тип объекта, который будет использоваться для передачи данных в метод render, предназначенный для отображения данных в компоненте. Конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Класс содержит метод render, который сохраняет полученные данные в полях компонента через их сеттеры и возвращает обновленный контейнер компонента.

#### Класс Page
Класс Page представляет собой компонент страницы, который управляет состоянием страницы, отображением корзины и счетчиком товаров в корзине. Он позволяет блокировать или разблокировать страницу, а также обновлять отображение счетчика корзины. Класс реагирует на взаимодействие с корзиной, передавая события через брокер событий.

Поля класса:
- `container: HTMLElement` — контейнер, в котором находятся все элементы интерфейса страницы (наследуется от класса Component).
- `_pageWrapper: HTMLElement` — обёртка всей страницы, которая может быть заблокирована для предотвращения взаимодействия с пользователем (например, при открытой корзине).
- `_basket: HTMLElement` — элемент корзины, на который можно кликнуть для открытия корзины.
- `_counter: HTMLElement` — элемент, отображающий количество товаров в корзине.

Методы класса:
- `setCounter(value: number): void` - Метод для обновления отображаемого значения счетчика товаров в корзине. Принимает число value и обновляет текстовое содержимое элемента счетчика _counter.
- `сеттер` который управляет состоянием блокировки страницы.


#### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.
- `constructor(selector: string, events: IEvents)` - конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для инициации событий.

Поля класса:
- `modal: HTMLElement` - элемент модального окна;
- `content: HTMLElement` — текущий контент модального окна;
- `events: IEvents` - брокер событий;

Методы класса:
- `open(): void` — открывает модальное окно, добавляя CSS-класс modal_active и эмитирует событие modal:open;
- `close(): void` — закрывает модальное окно, удаляя CSS-класс modal_active и эмитирует событие modal:close;
- `handleEscUp(evt: KeyboardEvent): void` — обрабатывает нажатие клавиши Esc для закрытия модального окна;
- `setContent(content: HTMLElement): void` — обновляет контент модального окна, устанавливая переданный элемент content и обновляя соответствующее поле;
- `render(): void` — обновляет DOM внутри модального окна, отображая текущий контент, сохраненный в поле content;

#### Класс Card
Предоставляет универсальное решение для рендера карточек любого типа. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.
- `constructor(container: HTMLTemplateElement, events: IEvents)` - в конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. Помимо темплейта конструктор принимает экземпляр `EventEmitter` для инициации событий.\

Поля класса:
- `productId: string` — идентификатор товара.
- `events: IEvents` — брокер событий;
- `titleName: HTMLElement` — элемент, содержащий название товара.
- `cardDescription: HTMLElement` — элемент, содержащий описание товара.
- `cardCategory: HTMLElement` — элемент, содержащий категорию товара.
- `cardImage: HTMLImageElement` — элемент, содержащий изображение товара.
- `cardPrice: HTMLElement` — элемент, содержащий цену товара.
- `actionButton: HTMLButtonElement` — кнопка для добавления товара в корзину или удаления из нее.
- `container: HTMLElement` — корневой элемент карточки.

Методы класса:
- `updateButtonState(isInBasket: boolean): void` — обновляет текст на кнопке в зависимости от того, находится ли товар в корзине (например, "В корзину" или "Удалить из корзины").
- `сеттеры` и `геттеры` для сохранения и получения данных из полей класса;

#### Класс CardsContainer
Отвечает за отображение блока с карточками на главной странице.
- сеттер `container` для полного обновления содержимого. В конструктор принимает контейнер, в котором размещаются карточки.

#### Класс Basket
Реализует модальное окно корзины для отображения добавленных товаров, их количества, общей стоимости, а также кнопки для удаления товара и оформление заказа.

Поля класса:
- `basketData: IBasket` — данные корзины, включающие список товаров и их количество.
- `container: HTMLElement` — контейнер, в который будет вставляться разметка корзины.
- `events: IEvents` — брокер событий для эмитации и прослушивания событий.
- `listElement: HTMLUListElement` — контейнер для списка товаров в корзине.
- `totalPriceElement: HTMLElement` — элемент для отображения общей стоимости товаров в корзине.
- `checkoutButton: HTMLButtonElement` — кнопка для оформления заказа.
- `cardTemplate: HTMLTemplateElement` — шаблон карточки товара, используемый для генерации элемента корзины.

Методы класса:
- `createBasketCard(item: IProduct, index: number): HTMLElement` — создает карточку товара для корзины. Каждый элемент содержит информацию о товаре и кнопку для его удаления. При клике на кнопку удаляется соответствующий товар из корзины.
- `renderBasket(): HTMLElement` — генерирует разметку для отображения всех товаров в корзине, обновляет список товаров и общую стоимость. Метод возвращает обновленный контейнер с корзиной.
- `updateTotalPrice(): void` — обновляет отображение общей стоимости товаров в корзине, форматируя цену в рублях с разделением тысяч.
- `updateButtonState(isInBasket: boolean): void` — обновляет состояние кнопки оформления заказа. Если корзина пуста, кнопка будет недоступна.
- `handleCheckout(): void` — инициирует процесс оформления заказа, генерируя событие через брокера событий basket:checkout.

#### Класс Form
Класс Form реализует функциональность для обработки формы оформления заказа. Он управляет валидацией введённых данных, состоянием кнопки отправки формы, а также управляет выбором способа оплаты и отправкой данных через брокер событий.

Поля класса:
- `container: HTMLFormElement` — элемент формы, который содержит все поля для ввода данных о заказе.
- `events: IEvents` — брокер событий для взаимодействия с другими частями системы.
- `inputs: NodeListOf<HTMLInputElement>` — коллекция всех элементов формы с атрибутом name.
- `paymentButtons: NodeListOf<HTMLButtonElement>` — коллекция кнопок выбора способа оплаты (например, "Картой" или "Наличные").
- `_form: HTMLFormElement` — ссылка на саму форму для работы с её элементами.
- `formName: string` — имя формы (используется для идентификации и событий).
- `submitButton: HTMLButtonElement` — кнопка для отправки формы (например, кнопка "Далее").
- `errorsContainer: HTMLElement` — контейнер для вывода ошибок формы.

Методы класса:
- `initEventListeners()` - Метод инициализирует обработчики событий для формы. Он устанавливает обработчики для отправки формы, а также для изменений в полях ввода и кнопках выбора способа оплаты.
- `updateFormValidity()` - Метод для проверки валидности всех полей формы. Он проверяет обязательные поля (например, адрес, email и телефон) и обновляет состояние ошибки и кнопки отправки. Также проверяет, выбран ли способ оплаты (для формы заказа).
- `handleButtonClick(evt: MouseEvent)` - Обрабатывает клик на кнопки выбора способа оплаты. Этот метод визуально выделяет выбранный способ и отправляет информацию о выбранном способе оплаты через события.
- `getInputValues(): Record<string, string>` - Собирает значения всех полей формы (включая выбранный способ оплаты) и возвращает их в виде объекта.
- `reset()` - Метод для сброса формы, очищая все поля, ошибки и выбранные способы оплаты. Сбрасывает состояние кнопки отправки формы.
- `getContainer(): HTMLElement` - Возвращает контейнер формы, что может быть полезно для рендеринга или получения доступа к элементам формы извне.
- `сеттеры` и `геттеры` для управления сообщениями об ошибках в форме и управления состоянием кнопки отправки формы;

#### Класс OrderSuccess
Класс OrderSuccess реализует функциональность для отображения успешного завершения оформления заказа. Он управляет состоянием экрана с уведомлением о успешной оплате, отображает описание успешного заказа, а также предоставляет возможность закрытия этого окна.

Поля класса:
- `container: HTMLElement` — контейнер, содержащий все элементы интерфейса для отображения информации о заказе.
- `closeButton: HTMLButtonElement` — кнопка для закрытия уведомления об успешном заказе.
- `orderSuccessTitle: HTMLElement` — заголовок уведомления о завершении заказа (например, "Заказ завершён").
- `orderSuccessDescription: HTMLElement` — описание успешного завершения заказа, которое может содержать информацию о списанной сумме.
- `events: IEvents` — брокер событий, который используется для передачи событий о закрытии окна успешного заказа.

Методы класса:
- `updateOrderSuccess(totalAmount: number): void` - Метод для обновления описания успешного завершения заказа. Он обновляет текст в orderSuccessDescription, выводя информацию о списанной сумме.
- `getContainer(): HTMLElement` - Возвращает контейнер, в котором отображается уведомление об успешном завершении заказа. Этот метод может быть полезен для рендеринга или получения доступа к элементам контейнера извне.

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

## Список всех событий, которые могут генерироваться в системе:
### События интерфейса (View Layer)
Эти события генерируются при взаимодействии пользователя с интерфейсом.

#### Модальные окна:
`modal:open` — открытие модального окна;\
`modal:close` — закрытие модального окна;\
`success:open` — открытие модального окна с подтверждением успешной оплаты;
`success:close` — закрытие модального окна успешной оплаты;

#### Карточки товаров:
`card:click` - уведомляет о том, что пользователь кликнул по карточке в галерее, передавая её уникальный идентификатор для дальнейшей обработки;\
`card:add` — добавление/удаление карточки товара в корзине;\

#### Формы:
`order:input` — изменение данных адреса доставки в форме;\
`contacts:input` — изменение данных контактов в форме;\
`order:submit` — сохранение данных адреса в форме;\
`contacts:submit` — сохранение данных контактов в форме;

### События работы с данными
Эти события генерируются классами CheckoutForm, ProductCardsData и Basket:

#### Корзина (Basket):
`basket:updated` — обновление содержимого корзины (добавление/удаление товара);\
`basket:cleared` — очистка корзины после завершения заказа;\

#### Данные формы заказа (CheckoutForm):
`form:paymentAddressUpdated` — обновление данных способа оплаты или адреса доставки;\
`form:contactUpdated` — обновление данных контактов;\
`form:orderCreated` — создание объекта заказа;\
`form:cleared` — очистка данных формы заказа;

### События завершения работы
`order:closeSuccess` — заказ успешно завершен, данные отправлены серверу, корзина очищена;