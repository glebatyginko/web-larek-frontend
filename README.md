# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении:

Товар

```
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null; 
}
```
Интерфейс, описывающий структуру данных заказа
```
export interface IOrderData {
	payment: TPayment | string;
	email: string;
	phone: string;
	address: string;
	total: number | null;
	items: string[];
}
```

Интерфейс для модели данных товаров

```
export interface IProductsData {
	products: IProduct[];
	preview: IProduct;
	total: number;
	setProducts(products: IProduct[]): void;
	selectProduct(item: IProduct): void;
}
```
Интерфейс для модели данных корзины
```
export interface IBasket {
	items: IProduct[];
	totalAmount: number | null;
	addItem(product: IProduct): void;
	removeItem(product: IProduct): void;
	getItemCount(): number;
	updateTotalAmount(): void;
	clearBasket(): void;
}
```
Интерфейс для модели данных формы
```
export interface ICheckoutForm {
	payment: TPayment;
	email: string;
	phone: string;
	address: string;
	total: number | null;
	items: string[];
	updatePaymentAndAddressInfo(
		field: keyof TPaymentFormInfo,
		value: string | TPayment
	): void;
	updateContactInfo(field: keyof TContactFormInfo, value: string): void;
	createOrderData(): object;
	clearForm(): void;
}
```

Данные способа оплаты

```
export type TPayment = 'cash' | 'card';
```
Данные карточки на главной странице

```
type TMainProductCardInfo = Pick<IProduct, 'id' | 'image' | 'title' | 'category' | 'price'>;
```
Данные карточки в корзине

```
type TBasketInfo = Pick<IProduct, 'title' | 'price'>;
```
Данные модального окно формы оплаты

```
type TPaymentFormInfo = Pick<IOrderData, 'paymentMethod' | 'deliveryAddress'>;
```
Данные модального окна формы контактов

```
type TContactFormInfo = Pick<IOrderData, 'email' | 'phone'>;
```

Допустимые HTTP-методы для отправки данных: POST, PUT или DELETE
```
type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

IApi — интерфейс, описывающий базовую структуру API клиента для взаимодействия с сервером.
```
export interface IApi {
	baseUrl: string;
	get<T>(uri: string): Promise<T>;
	post<T>(uri: string, data: object, method?: ApiPostMethods): Promise<T>;
}
```

## Архитектура приложения:

Код приложения разделен на слои согласно парадигме MVP:
- Слой представления, отвечает за отображение данных на странице
- Слой данных, отвечает за хранение и изменение данных
- Презентер, отвечает за связь представления и данных

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

Методы:
- `get` - выполняет `GET` запрос на переданный в параметрах эндпоинт и возвращает промис с объектом, которым ответил сервер.
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на эндпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие.
- `emit` - инициализация события.
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие.

### Слой данных

#### Класс ProductCardsData

Класс отвечает за хранение и логику работы с данными карточек товаров.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `_products: IProduct[]` - массив объектов карточек;
- `_preview: IProduct | null` - объект, представляющий выбранный товар;
- `_total: number` — общее количество товаров в массиве;
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `selectProduct(item: IProduct): void` - выбирает карточку;
- `setProducts(products: IProduct[]): void` — метод для установки массива товаров. Обновляет количество товаров и эмитирует событие products:updated;
- `getProduct(cardId: string): IProduct | undefined` — метод для получения товара по его идентификатору;
- `сеттеры` и `геттеры` для сохранения и получения данных из полей класса;

#### Класс BasketData

Класс отвечает за работу с данными в корзине.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `items: IProduct[]` - массив объектов типа TBasketInfo, содержащий информацию о товарах в корзине. Каждый объект включает название товара и его цену; 
- `totalAmount: number | null` - хранит общую сумму всех товаров в корзине. Изначально может быть null, если корзина пуста; 
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `addItem(product: IProduct): void` - добавляет товар в корзину и добавляет его в массив `items`; 
- `removeItem(product: IProduct): void` - удаляет товар из корзины. Ищет и удаляет элемент в массиве `items`, соответствующий переданному товару.; 
- `getItemCount(): number` - возвращает количество товаров в корзине, равное длине массива items; 
- `updateTotalAmount(): void` - вычисляет общую стоимость товаров в корзине, суммируя цены всех элементов в массиве `items`; 
- `clearBasket(): void` - полностью очищает корзину, обнуляя массив `items` и сбрасывая totalAmount в null; 

#### Класс FormData

Класс отвечает за работу с данными в форме.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `payment: TPayment | null` — способ оплаты (наличные или карта), изначально null;
- `email: string` — электронная почта пользователя;
- `phone: string` — номер телефона пользователя;
- `address: string` — адрес доставки;
- `total: number | null` — общая сумма заказа, изначально может быть null;
- `items: string[]` — массив товаров, которые входят в заказ (идентификаторы товаров);
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `updateTotalAndItems(totalAmount: number | null, items: string[]): void` — обновляет общую сумму и список товаров в заказе. Эмитирует событие - form:totalAndItemsUpdated.\
- `updatePaymentAndAddressInfo(field: keyof TPaymentFormInfo, value: string | TPayment): void` — обновляет информацию о способе оплаты или адресе доставки в зависимости от переданного поля. Эмитирует событие form:paymentAddressUpdated.\
- `updateContactInfo(field: keyof TContactFormInfo, value: string): void` — обновляет контактные данные (email или телефон). Эмитирует событие form:contactUpdated.\
- `createOrderData(): IOrderData` — формирует объект данных заказа, включая товары, итоговую сумму, контактные данные, способ оплаты и адрес доставки. Если общая сумма равна нулю или null, выбрасывает ошибку.\
- `clearForm(): void` — очищает все данные формы (способ оплаты, адрес, контактные данные, товары и сумма) и эмитирует событие form:cleared.

### Слой представления

Все классы представления отвечают за отображение внутри контейнера (DOM - элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем для некоторых компонентов слоя представления. В дженерик передается тип объекта, который будет использоваться для передачи данных в метод render, предназначенный для отображения данных в компоненте. Конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Класс содержит метод render, который сохраняет полученные данные в полях компонента через их сеттеры и возвращает обновленный контейнер компонента.

#### Класс Page
Класс Page представляет собой компонент страницы, который управляет состоянием страницы, отображением корзины и счетчиком товаров в корзине. Он позволяет блокировать или разблокировать страницу, а также обновлять отображение счетчика корзины. Класс реагирует на взаимодействие с корзиной, передавая события через брокер событий.

Поля класса:
- `container: HTMLElement` — контейнер, в котором находятся все элементы интерфейса страницы (наследуется от класса Component).
- `_pageWrapper: HTMLElement` — обёртка всей страницы, которая может быть заблокирована для предотвращения взаимодействия с пользователем (например, при открытой корзине).
- `_basket: HTMLElement` — элемент корзины, на который можно кликнуть для открытия корзины.
- `_counter: HTMLElement` — элемент, отображающий количество товаров в корзине.

Методы класса:
- `setCounter(value: number): void` - Метод для обновления отображаемого значения счетчика товаров в корзине. Принимает число value и обновляет текстовое содержимое элемента счетчика _counter.
- `сеттер` который управляет состоянием блокировки страницы.


#### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.
- `constructor(selector: string, events: IEvents)` - конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для инициации событий.

Поля класса:
- `modal: HTMLElement` - элемент модального окна;
- `content: HTMLElement` — текущий контент модального окна;
- `events: IEvents` - брокер событий;

Методы класса:
- `open(): void` — открывает модальное окно, добавляя CSS-класс modal_active и эмитирует событие modal:open;
- `close(): void` — закрывает модальное окно, удаляя CSS-класс modal_active и эмитирует событие modal:close;
- `handleEscUp(evt: KeyboardEvent): void` — обрабатывает нажатие клавиши Esc для закрытия модального окна;
- `setContent(content: HTMLElement): void` — обновляет контент модального окна, устанавливая переданный элемент content и обновляя соответствующее поле;
- `render(): void` — обновляет DOM внутри модального окна, отображая текущий контент, сохраненный в поле content;

#### Класс Card
Предоставляет универсальное решение для рендера карточек любого типа. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.
- `constructor(container: HTMLTemplateElement, events: IEvents)` - в конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. Помимо темплейта конструктор принимает экземпляр `EventEmitter` для инициации событий.\

Поля класса:
- `productId: string` — идентификатор товара.
- `events: IEvents` — брокер событий;
- `titleName: HTMLElement` — элемент, содержащий название товара.
- `cardDescription: HTMLElement` — элемент, содержащий описание товара.
- `cardCategory: HTMLElement` — элемент, содержащий категорию товара.
- `cardImage: HTMLImageElement` — элемент, содержащий изображение товара.
- `cardPrice: HTMLElement` — элемент, содержащий цену товара.
- `actionButton: HTMLButtonElement` — кнопка для добавления товара в корзину или удаления из нее.
- `container: HTMLElement` — корневой элемент карточки.

Методы класса:
- `updateButtonState(isInBasket: boolean): void` — обновляет текст на кнопке в зависимости от того, находится ли товар в корзине (например, "В корзину" или "Удалить из корзины").
- `сеттеры` и `геттеры` для сохранения и получения данных из полей класса;

#### Класс CardsContainer
Отвечает за отображение блока с карточками на главной странице.
- сеттер `container` для полного обновления содержимого. В конструктор принимает контейнер, в котором размещаются карточки.

#### Класс Basket
Класс Basket отвечает за управление корзиной покупок на веб-странице. Он реализует отображение товаров в корзине, обновление общей стоимости и управление состоянием кнопки оформления заказа. Также класс отправляет события, связанные с процессом оформления заказа.

Поля класса:
- `container: HTMLElement` — контейнер, который содержит элементы корзины (список товаров, общую сумму и кнопку оформления заказа).
- `events: IEvents` — брокер событий для эмитации и прослушивания событий.
- `listElement: HTMLUListElement` — элемент списка, в который добавляются товары в корзину.
- `totalPriceElement: HTMLElement` — элемент, отображающий общую сумму корзины.
- `checkoutButton: HTMLButtonElement` — кнопка для оформления заказа.

Методы класса:
- `renderBasket(items: HTMLElement[], totalAmount: number)` — рендерит список товаров в корзине и обновляет общую сумму.
- `updateTotalPrice(totalAmount: number)` — обновляет отображение общей суммы корзины.
- `updateButtonState(isInBasket: boolean)` — включает или выключает кнопку оформления заказа в зависимости от наличия товаров в корзине.
- `handleCheckout()` — генерирует событие оформления заказа.

#### Класс BasketItem
Класс BasketItem представляет отдельный товар в корзине. Он используется для отображения информации о товаре, такой как название, цена, а также для управления действиями с товаром (удаление).

Поля класса:
- `productId: string` — уникальный идентификатор товара.
- `events: IEvents` — брокер событий для эмитации и прослушивания событий.
- `titleName: HTMLElement` — HTML-элемент, в котором отображается название товара.
- `cardPrice: HTMLElement` — HTML-элемент, в котором отображается цена товара.
- `deleteButton: HTMLButtonElement` — кнопка удаления товара из корзины.
- `indexElement: HTMLElement` — HTML-элемент, отображающий индекс товара в корзине.

Геттеры и сеттеры:
- `геттеры` и `сеттеры` позволяют получать и устанавливать уникальный идентификатор товара (id), название товара (title), цену товара (price), а также индекс товара в корзине (index).

#### Класс Form
Абстрактный класс для работы с формами. Этот класс реализует базовую функциональность для обработки ввода данных и отправки данных через событие. Он управляет состоянием формы, обрабатывает события ввода и отправки, а также обновляет статус кнопки отправки.

Поля класса:
- `events: IEvents` — брокер событий для взаимодействия с другими частями системы.
- `inputs: NodeListOf<HTMLInputElement>` — список всех элементов ввода (input), находящихся в форме.
- `submitButton: HTMLButtonElement` — кнопка отправки формы.
- `formName: string` — имя формы, используемое для генерации уникальных событий.
- `valid: boolean` — флаг, который указывает, является ли форма валидной.
- `inputValues: Record<string, string>` — объект, содержащий текущие значения всех полей ввода формы.
- `errorsContainer: HTMLElement` — контейнер для отображения ошибок формы.

Методы класса:
- `initEventListeners()` - Метод для привязки обработчиков событий:
При изменении значения любого поля ввода обновляется объект inputValues и проверяется валидность формы.
- `abstract updateFormValidity()` - Абстрактный метод для обновления валидности формы. Должен быть реализован в подклассах.
- `getInputValues()` - Метод для получения всех значений ввода формы в виде объекта с именами полей в качестве ключей и значениями ввода в качестве значений.
- `getContainer()` - Метод для получения контейнера формы.
- `сеттеры` и `геттеры` для управления сообщениями об ошибках в форме и управления состоянием кнопки отправки формы;

#### Класс PaymentForm
Класс, который расширяет базовый абстрактный класс Form и предназначен для работы с формой оплаты. Он добавляет логику выбора способа оплаты (карта или наличные) и проверяет, выбрал ли пользователь способ оплаты, а также заполнил ли необходимые поля.

Поля класса:
- `paymentButtons: NodeListOf<HTMLButtonElement>` — список кнопок для выбора способа оплаты (карта и наличные).

Методы класса:
- `getInputValues()` - Переопределенный метод для получения значений полей ввода. Дополнительно к стандартным полям добавляется поле payment, которое будет содержать способ оплаты, выбранный пользователем (если он выбрал способ оплаты).
- `initPaymentButtonListeners()` - Метод для привязки обработчиков событий к кнопкам выбора способа оплаты. При клике на одну из кнопок, вызывается метод handlePaymentButtonClick, который обновляет выбор пользователя.
- `handlePaymentButtonClick(evt: MouseEvent)` - Метод для обработки клика на кнопке способа оплаты. В нем обновляется активная кнопка, добавляется/удаляется класс button_alt-active и обновляются значения формы.
- `updateFormValidity()` - Метод для обновления валидности формы.

#### Класс ContactForm
Класс, который расширяет абстрактный класс Form и предназначен для работы с формой ввода контактных данных пользователя, таких как email и телефон.

Методы класса:
- `updateFormValidity()` - Метод проверяет корректность введенных контактных данных в полях формы.

#### Класс OrderSuccess
Класс OrderSuccess реализует функциональность для отображения успешного завершения оформления заказа. Он управляет состоянием экрана с уведомлением о успешной оплате, отображает описание успешного заказа, а также предоставляет возможность закрытия этого окна.

Поля класса:
- `container: HTMLElement` — контейнер, содержащий все элементы интерфейса для отображения информации о заказе.
- `closeButton: HTMLButtonElement` — кнопка для закрытия уведомления об успешном заказе.
- `orderSuccessTitle: HTMLElement` — заголовок уведомления о завершении заказа (например, "Заказ завершён").
- `orderSuccessDescription: HTMLElement` — описание успешного завершения заказа, которое может содержать информацию о списанной сумме.
- `events: IEvents` — брокер событий, который используется для передачи событий о закрытии окна успешного заказа.

Методы класса:
- `updateOrderSuccess(totalAmount: number): void` - Метод для обновления описания успешного завершения заказа. Он обновляет текст в orderSuccessDescription, выводя информацию о списанной сумме.
- `getContainer(): HTMLElement` - Возвращает контейнер, в котором отображается уведомление об успешном завершении заказа. Этот метод может быть полезен для рендеринга или получения доступа к элементам контейнера извне.

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

## Список всех событий, которые могут генерироваться в системе:
### События интерфейса (View Layer)
Эти события генерируются при взаимодействии пользователя с интерфейсом.

#### Обновление и взаимодействие с продуктами:
`products:updated` - уведомляет о том, что список продуктов обновлён, и генерирует обновлённые карточки товаров для отображения.\
`cardActionButton:click` - обрабатывает клик по кнопке действия карточки товара, добавляя или удаляя товар из корзины и обновляя состояние кнопки.\
`card:click` - уведомляет о том, что пользователь кликнул по карточке в галерее, передавая её уникальный идентификатор для дальнейшей обработки;\

#### Оформление заказа:
`basket:checkout` — инициирует оформление заказа, проверяя наличие товаров в корзине и обновляя информацию о сумме и товарах в форме заказа.
`order:createData` — вызывает создание данных заказа.

#### Модальные окна:
`modal:open` — открытие модального окна.
`modal:close` — закрытие модального окна.
`success:open` — открытие модального окна с подтверждением успешной оплаты.
`success:close` — закрытие модального окна успешной оплаты.

### События работы с данными
#### Корзина:
`basket:updated` — обновление содержимого корзины (добавление/удаление товара).
`basket:cleared` — очистка корзины после завершения заказа.
`basket:item-remove` — удаление товара из списка в корзине.
`basket:open` — открытие корзины.

#### Данные формы заказа:
`form:paymentAddressUpdated` — обновление данных способа оплаты или адреса доставки.
`form:contactUpdated` — обновление данных контактов.
`form:orderCreated` — отправляет данные на сервер, очищает корзину и форму, обновляет счетчик товаров и отображает успешное оформление заказа.
`form:cleared` — очистка данных формы заказа.

### События завершения работы
`order:closeSuccess` — заказ успешно завершен.