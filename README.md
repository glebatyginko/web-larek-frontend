# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении:

Товар

```
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null; 
}
```
Интерфейс, описывающий структуру данных заказа
```
export interface IOrderData {
  payment: string;
  email: string;
  phone: string;
  address: string;
  total: number | null;
  items: string[];
}
```

Интерфейс для модели данных товаров

```
export interface IProductsData {
  products: IProduct[];
  preview: IProduct;
  selectProduct(item: IProduct): void;
}
```
Интерфейс для модели данных корзины
```
export interface IBasket {
  items: IProduct[]; 
  totalAmount: number | null; 
  addItem(product: IProduct): void; 
  removeItem(product: IProduct): void; 
  getItemCount(): number; 
  updateTotalAmount(): void;
  clearBasket(): void; 
}
```
Интерфейс для модели данных формы
```
export interface ICheckoutForm {
  payment: TPayment; 
  email: string; 
  phone: string; 
  address: string; 
  total: number | null; 
  items: string[]; 
  paymentAndAddressInfoValid(data: TPaymentFormInfo): boolean;
  contactInfoValid(data: TContactFormInfo): boolean;
  updatePaymentAndAddressInfo(
    field: keyof TPaymentFormInfo, 
    value: string | TPayment
  ): void;
  updateContactInfo(
    field: keyof TContactFormInfo, 
    value: string
  ): void;
  createOrderData(): object;
  clearForm(): void;
}
```

Данные способа оплаты

```
export type TPayment = 'cash' | 'card';
```
Данные карточки на главной странице

```
type TMainProductCardInfo = Pick<IProduct, 'id' | 'image' | 'title' | 'category' | 'price'>;
```
Данные карточки в корзине

```
type TBasketInfo = Pick<IProduct, 'title' | 'price'>;
```
Данные модального окно формы оплаты

```
type TPaymentFormInfo = Pick<IOrderData, 'paymentMethod' | 'deliveryAddress'>;
```
Данные модального окна формы контактов

```
type TContactFormInfo = Pick<IOrderData, 'email' | 'phone'>;
```

Допустимые HTTP-методы для отправки данных: POST, PUT или DELETE
```
type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

## Архитектура приложения:

Код приложения разделен на слои согласно парадигме MVP:
- Слой представления, отвечает за отображение данных на странице
- Слой данных, отвечает за хранение и изменение данных
- Презентер, отвечает за связь представления и данных

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.

Методы:
- `get` - выполняет `GET` запрос на переданный в параметрах эндпоинт и возвращает промис с объектом, которым ответил сервер.
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на эндпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие.
- `emit` - инициализация события.
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие.

### Слой данных

#### Класс ProductCardsData

Класс отвечает за хранение и логику работы с данными карточек товаров.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `_products: IProduct[]` - массив объектов карточек;
- `_preview: IProduct | null` - объект, представляющий выбранный товар;
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `selectProduct(item: IProduct): void` - выбирает карточку;
- `сеттеры` и `геттеры` для сохранения и получения данных из полей класса;

#### Класс BasketData

Класс отвечает за работу с данными в корзине.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `items: IProduct[]` - массив объектов типа TBasketInfo, содержащий информацию о товарах в корзине. Каждый объект включает название товара и его цену; 
- `totalAmount: number | null` - хранит общую сумму всех товаров в корзине. Изначально может быть null, если корзина пуста; 
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `addItem(product: IProduct): void` - добавляет товар в корзину и добавляет его в массив `items`; 
- `removeItem(product: IProduct): void` - удаляет товар из корзины. Ищет и удаляет элемент в массиве `items`, соответствующий переданному товару.; 
- `getItemCount(): number` - возвращает количество товаров в корзине, равное длине массива items; 
- `updateTotalAmount(): void` - вычисляет общую стоимость товаров в корзине, суммируя цены всех элементов в массиве `items`; 
- `clearBasket(): void` - полностью очищает корзину, обнуляя массив `items` и сбрасывая totalAmount в null; 

#### Класс FormData

Класс отвечает за работу с данными в форме.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- `paymentMethod: TPayment | null` - тип оплаты: наличные или карта, изначально null; 
- `deliveryAddress: string` - адрес доставки; 
- `email: string` - электронная почта пользователя; 
- `phone: string` - телефонный номер пользователя; 
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных;

Так же класс предоставляет набор методов для работы с этими данными:
- `paymentAndAddressInfoValid(data: TPaymentFormInfo): boolean` - проверяет, что способ оплаты и адрес доставки указаны корректно;
- `contactInfoValid(data: TContactFormInfo): boolean` - проверяет, что email и телефон введены в правильном формате;
- `updatePaymentAndAddressInfo(
    field: keyof TPaymentFormInfo, 
    value: string | TPayment
  ): void` - обновляет способ оплаты или адрес доставки в зависимости от переданного поля;
- `updateContactInfo(
    field: keyof TContactFormInfo, 
    value: string
  ): void` - обновляет электронную почту или телефон;
- `createOrderData(): object` - формирует объект с данными заказа: товары, итоговая сумма, контактные данные, способ оплаты и адрес доставки;

### Слой представления

Все классы представления отвечают за отображение внутри контейнера (DOM - элемент) передаваемых в них данных.

#### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.
- `constructor(selector: string, events: IEvents)` - конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для инициации событий.

Поля класса:
- `modal: HTMLElement` - элемент модального окна;
- `content: HTMLElement` — текущий контент модального окна;
- `events: IEvents` - брокер событий;

Методы класса:
- `setContent(content: HTMLElement): void` - устанавливает переданный элемент content в модальное окно и сохраняет новый контент в поле content;
 - `render(): void` - обновляет DOM внутри модального окна, отображая текущий контент, сохраненный в поле content;

#### Класс Card
Предоставляет универсальное решение для рендера карточек любого типа. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.
- `constructor(container: HTMLTemplateElement, events: IEvents)` - в конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. Помимо темплейта конструктор принимает экземпляр `EventEmitter` для инициации событий.\

Поля класса:
- `id: string` — идентификатор товара;
- `title: HTMLElement` — название товара;
- `description: HTMLElement` — описание товара;
- `category: HTMLElement` — категория товара;
- `image: HTMLImageElement` — изображение товара;
- `price: HTMLElement` — цена товара;
- `cardElement: HTMLElement` — корневой элемент карточки;
- `events: IEvents` — брокер событий;

Методы класса:
- `render(cardData: Partial<IProduct>): HTMLElement` - заполняет атрибуты элементов карточки данными. Метод возвращает разметку карточки с установленными слушателями. Слушатели устанавливаются на все интерактивные элементы карточки и генерируют соответствующие события через экземпляр брокера событий;
- `updateButtonState(isInBasket: boolean): void` /////
- геттер id возвращает уникальный id карточки;

#### Класс CardsContainer
Отвечает за отображение блока с карточками на главной странице.
- сеттер `container` для полного обновления содержимого. В конструктор принимает контейнер, в котором размещаются карточки.

#### Класс ModalBasket
Реализует модальное окно корзины для отображения добавленных товаров, их количества, общей стоимости, а также кнопки для удаления товара и оформление заказа.

Поля класса:
- `listContainer: HTMLElement` — контейнер для отображения списка товаров;
- `totalPriceElement: HTMLElement` — элемент для отображения общей стоимости товаров в корзинее;
- `events: IEvents` - брокер событий;

Методы класса:
- `setItems(items: TBasketInfo[]): void` - принимает коллекцию блоков разметки элементов списка и устанавливает эту коллекцию в контейнер;
- `checkout()` - оформляет заказ и очищает корзину;
- `renderItemCountIndicator()` - метод обновляет количество товаров в корзине, отображаемое на значке корзины в заголовке страницы;
- `render()` - генерирует HTML-код для отображения товаров в корзине, их цен и кнопок для удаления;

#### Класс ModalOrder
Реализует функциональность модального окна для оформления заказа. Оно предоставляет пользователю возможность выбора способа оплаты и ввода адреса доставки, а также управляет валидацией и изменением состояния кнопки "Далее" в зависимости от введённых данных.

Поля класса:
- `form: HTMLFormElement` - элемент формы;
- `submitButton: HTMLButtonElement` — кнопка "Далее" для продолжения оформления заказа;
- `paymentButtons: NodeListOf<HTMLElement>` — кнопки выбора способа оплаты;
- `errors: Record<string, HTMLElement>` - объект хранящий все элементы для вывода ошибок;
- `events: IEvents` - брокер событий;

Методы класса:
- `selectPaymentMethod(method: string)` - обрабатывает выбор способа оплаты, визуально выделяет выбранный метод и сохраняет выбор;
- `validateForm()` - проверяет, заполнено ли поле адреса, и активирует или деактивирует кнопку "Далее" на основе результата;
- `handleSubmit()` - отправляет данные о способе оплаты и адресе доставки через брокер событий, инициируя дальнейший процесс заказа;
- `render()` - генерирует HTML-код формы;

#### Класс ModalPayment
Реализует функциональность модального окна для ввода данных пользователя (электронной почты и номера телефона) перед оплатой, а также управляет валидацией и изменением состояния кнопки "Оплатить" в зависимости от введённых данных.

Поля класса:
- `form: HTMLFormElement` - элемент формы;
- `emailInput: HTMLInputElement` — поле для ввода электронного адреса;
- `phoneInput: HTMLInputElement` — поле для ввода номера телефона;
- `submitButton: HTMLButtonElement` — кнопка "Оплатить";
- `errors: Record<string, HTMLElement>` - объект хранящий все элементы для вывода ошибок;
- `events: IEvents` — брокер событий для взаимодействия с другими частями приложения;

Методы класса:
- `validateForm()` - проверяет, заполнено ли поле адреса, и активирует или деактивирует кнопку "Далее" на основе результата;
- `handleSubmit()` - отправляет данные о способе оплаты и адресе доставки через брокер событий, инициируя дальнейший процесс заказа;
- `render()` - генерирует HTML-код формы;

#### Класс ModalSuccess
Реализует функциональность модального окна успешной покупки. Constructor принимает шаблон и брокер событий.
Методы класса:
- `render()` - генерирует HTML-код модального окна завершения;

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

## Список всех событий, которые могут генерироваться в системе:
### События интерфейса (View Layer)
Эти события генерируются при взаимодействии пользователя с интерфейсом.

#### Модальные окна:
`modal:open` — открытие модального окна;\
`modal:close` — закрытие модального окна;\
`modalCardFull:open` — открытие модального окна с карточкой;\
`modalBasket:open` — открытие модального окна с корзиной;\
`modalOrder:open` — открытие модального окна с вариантами оплаты и адресом;\
`modalPayment:open` — открытие модального окна с контактами и завершением оплаты;\
`success:open` — открытие модального окна с подтверждением успешной оплаты;\
`success:close` — закрытие модального окна успешной оплаты;

#### Карточки товаров:
`card:click` - уведомляет о том, что пользователь кликнул по карточке в галерее, передавая её уникальный идентификатор для дальнейшей обработки;\
`card:addItem` — добавление карточки товара в корзину;\
`card:deleteItem` — удаление карточки товара из корзины;

#### Формы:
`order:input` — изменение данных адреса доставки в форме;\
`contacts:input` — изменение данных контактов в форме;\
`order:submit` — сохранение данных адреса в форме;\
`contacts:submit` — сохранение данных контактов в форме;

### События работы с данными
Эти события генерируются классами CheckoutForm и Basket:

#### Корзина (Basket):
`basket:updated` — обновление содержимого корзины (добавление/удаление товара);\
`basket:cleared` — очистка корзины после завершения заказа;\

#### Данные формы заказа (CheckoutForm):
`form:stepOneInvalid` - сигнализирует о том, что данные оплаты или адрес доставки введены некорректно и требуют исправления;\
`form:stepTwoInvalid` - сигнализирует о том, что данные контактов введены некорректно и требуют исправления;\
`form:paymentAddressUpdated` — обновление данных способа оплаты или адреса доставки;\
`form:contactUpdated` — обновление данных контактов;\
`form:orderCreated` — создание объекта заказа;\
`form:cleared` — очистка данных формы заказа;

### События валидации
Эти события сообщают об успешной или проваленной проверке данных:

`order:validation` — событие, запрашивающее валидацию формы с адресом доставки;\
`contacts:validation` — событие, запрашивающее валидацию формы с контактами;\
`form:valid` — форма успешно прошла проверку (генерируется CheckoutForm);\
`form:invalid` — форма не прошла проверку (генерируется CheckoutForm);

### События завершения работы
`order:completed` — заказ успешно завершен, данные отправлены серверу, корзина очищена;